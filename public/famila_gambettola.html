<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Famila Gambettola - Stato Coda</title>
    <link rel="stylesheet" href="../assets/style.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <header>
        <a href="index.html">
            <img src="../assets/logo.png" alt="Logo" class="logo" />
        </a>
        <h1>Famila Gambettola ‚Äì Stato della Coda</h1>
    </header>

    <main>
        <div class="stat">Persone in coda: <span id="count">0</span></div>
        <div class="stat">Tempo stimato: <span id="time">0</span> minuti</div>

        <h3>Andamento storico della coda</h3>
        <canvas id="queueChart" height="100"></canvas>

        <h3>Stato casse (persone in fila per cassa)</h3>
        <canvas id="cashChart" height="150"></canvas>
    </main>

    <footer>
        SmartLine &copy; 2025 ‚Äì Progetto universitario IoT
    </footer>

    <script>
        const topic = 'progetto/famila_gambettola';
        const storageKey = 'queueHistory_famila_gambettola';

        const queueCtx = document.getElementById('queueChart').getContext('2d');
        const cashCtx = document.getElementById('cashChart').getContext('2d');

        // Grafico storico code
        const queueChart = new Chart(queueCtx, {
            type: 'line',
            data: { labels: [], datasets: [{
                label: 'Persone in Coda',
                data: [],
                backgroundColor: 'rgba(0,191,166,0.2)',
                borderColor: '#00bfa6',
                borderWidth: 2,
                tension: 0.3,
                fill: true,
                pointRadius: 3,
                pointBackgroundColor: '#00bfa6'
            }] },
            options: {
                scales: { 
                    x: { ticks: { color: '#555' } }, 
                    y: { beginAtZero: true, ticks: { color: '#555' } } 
                },
                plugins: { legend: { labels: { color: '#333' } } }
            }
        });

        // Carica eventuale storico dal localStorage
        const saved = localStorage.getItem(storageKey);
        if (saved) {
            try {
                const parsed = JSON.parse(saved);
                queueChart.data.labels = parsed.labels;
                queueChart.data.datasets[0].data = parsed.data;
                queueChart.update();
            } catch (e) {
                console.error('Errore caricamento storico:', e);
            }
        }

        // Grafico stato casse (10 casse come nel firmware)
        const cashChart = new Chart(cashCtx, {
            type: 'bar',
            data: {
                labels: Array.from({ length: 10 }, (_, i) => `Cassa ${i + 1}`),
                datasets: [{ 
                    label: 'Persone in fila', 
                    data: Array(10).fill(0), 
                    backgroundColor: '#00bfa6' 
                }]
            },
            options: {
                indexAxis: 'y',
                scales: {
                    x: { beginAtZero: true, max: 6, ticks: { stepSize: 1, color: '#444' } },
                    y: { ticks: { color: '#444' } }
                },
                plugins: { legend: { display: false } }
            }
        });

        // WebSocket per ricevere dati in tempo reale
        const ws = new WebSocket('ws://localhost:3000');

        ws.onopen = () => {
            console.log('‚úÖ WebSocket connesso');
        };

        ws.onmessage = (event) => {
            try {
                const msg = JSON.parse(event.data);
                console.log("üì• Messaggio WebSocket ricevuto:", msg);

                const { topic: msgTopic, data } = msg;

                if (msgTopic === topic) {
                    const payload = JSON.parse(data);
                    
                    // Aggiorna contatori
                    document.getElementById('count').textContent = payload.queue_length || 0;
                    document.getElementById('time').textContent = payload.estimated_time || 0;

                    // Aggiorna grafico storico coda
                    const now = new Date();
                    const timeLabel = `${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`;

                    if (queueChart.data.labels.length >= 10) {
                        queueChart.data.labels.shift();
                        queueChart.data.datasets[0].data.shift();
                    }

                    queueChart.data.labels.push(timeLabel);
                    queueChart.data.datasets[0].data.push(payload.queue_length || 0);
                    queueChart.update();

                    // Salva storico
                    localStorage.setItem(storageKey, JSON.stringify({
                        labels: queueChart.data.labels,
                        data: queueChart.data.datasets[0].data
                    }));

                    // Aggiorna stato casse (10 casse come previsto)
                    if (Array.isArray(payload.casse) && payload.casse.length === 10) {
                        cashChart.data.datasets[0].data = payload.casse;
                        cashChart.update();
                    }
                }
            } catch (e) {
                console.error("‚ùå Errore parsing:", e);
            }
        };

        ws.onerror = (error) => {
            console.error('‚ùå Errore WebSocket:', error);
        };

        ws.onclose = () => {
            console.log('‚ùé WebSocket disconnesso');
        };
    </script>
</body>
</html>
